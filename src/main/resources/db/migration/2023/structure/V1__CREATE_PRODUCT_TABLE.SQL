create table trip_detail_record
(
    id        bigint generated by default as identity primary key,
    endtime   timestamp(6)     not null,
    sessionid varchar(50)      not null constraint cdr_sessoinid_unique unique,
    starttime timestamp(6)     not null,
    totalcost double precision not null constraint cdr_totalcost_check check (totalcost >= (0)::double precision),
    vehicleid varchar(50)      not null
);

CREATE OR REPLACE FUNCTION validate_start_time() RETURNS trigger AS
$$
BEGIN
    IF EXISTS (
        SELECT 1
        FROM trip_detail_record
        WHERE vehicleid = NEW.vehicleid
          AND trip_detail_record.endtime > NEW.starttime
    ) THEN
        RAISE EXCEPTION 'Start trip cannot be before the end time of another trip for the same vehicle.';
    END IF;

    RETURN NEW;
END;
$$
    LANGUAGE plpgsql;

CREATE TRIGGER validate_start_time_before_insert
    BEFORE INSERT ON trip_detail_record
    FOR EACH ROW
    EXECUTE PROCEDURE validate_start_time();
